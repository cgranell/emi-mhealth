---
title: 'Analysis and visualisations for "JMIR paper title here"'
author: "Carlos Granell et al."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    keep_tex: yes
    #latex_engine: xelatex
    toc: yes
urlcolor: blue    
---

## License

This document is licensed under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/).


## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(here)
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)
# library(ggalt)
library(scales)
library(RColorBrewer)
library(gridExtra)
library(treemap)
library(forcats)
library(purrr)

```


```{r session_info, echo=FALSE}
devtools::session_info(include_base = TRUE)
```

This document is versioned in a public [git](https://git-scm.com/) repo: [https://github.com/cgranell/emi-mhealth](https://github.com/cgranell/emi-mhealth).

\newpage

This R notebook contains the code to produce the final figures adn tables of the paper. 

## Data 

Input datasets are the processed datasets within the *emidata* data package. The package code is available in a public [git](https://git-scm.com/) repo: [https://github.com/cgranell/emidata](https://github.com/cgranell/emidata). We analyse the follwing three datasets of the *emidata* package: 

* *ipapers2018_psydata* (extracted data items related to psychology) has `` `r nrow(ipapers2018_psydata)` `` records and `` `r ncol(ipapers2018_psydata)` `` columns.
* *ipapers2018_csdata* (extracted data items related to tech/cs) has `` `r nrow(ipapers2018_csdata)` `` records and `` `r ncol(ipapers2018_csdata)` `` columns. 
* *ipapers2018* (list of analysed papers) has `` `r nrow(ipapers2018)` `` records and `` `r ncol(ipapers2018)` `` columns.


```{r all_data, echo=FALSE}

cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop "included" columns
all_data <- all_data %>% select(-id_csin, -id_psyin)

all_data <- all_data %>%
    inner_join(ipapers2018, by="id") %>%
    select(-filename, -title, -abstract, -journal, -author, -keywords)

# cast MD to factor
all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

#' Merge two factors levels into a new one "26-Various" 
all_data$md <- 
    all_data$md %>% 
    fct_collapse("26-Various" = c("23-Duo","24-Multiple"))

#' Sync changes of "md" to other two columns, "md_id"" and "md_desc""
all_data <- 
    all_data %>% 
        separate(md, c("md_id","md_desc"), "-", extra="merge", remove=FALSE)

all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

n_md <- nlevels(all_data$md)
n_papers = nrow(all_data)

category_levels <- c("YES","NO")
all_data <- 
    all_data %>%
    mutate(md_dsm5 = factor(if_else(md_id <= 22, "YES", "NO"), levels=category_levels))

n_yes_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "YES") %>%
        nrow()

n_no_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "NO") %>%
        nrow()

```

The final number of papers to analyse is `` `r n_papers` ``.

There are `` `r n_md` `` distinct mental disorders (out of 25). About `r percent(n_yes_dsm5/n_papers)` (N=`r n_yes_dsm5`) are categorised according to Section II of [DSM-5 manual](https://dsm.psychiatryonline.org/doi/book/10.1176/appi.books.9780890425596). About `r percent(n_no_dsm5/n_papers)` (N=`r n_no_dsm5`) are 23-Dual, 24-Multiple or 25-Suicidal behavior disorder/nonsuicidal self-injury. In the following analysis, categories 23 and 24 are merged into a new one: 26-Various. Therefore, dual and multiple disorders are jointly treated.


\newpage

## Key figures


### Figure 1 (proportional stacked area chart)

Proportional stacked area chart: Temporal distribution of papers colored by assessment type. The summ of each year is always equal to hundred, and the value of each group (assessment type) is in percentages


```{r key_plot_1_areachart, echo=FALSE, dpi=600, fig.width=12, fig.asp=0.65}
cols <- c("md", "md_id", "md_desc", "val_asstype", "year")

data_kp_areachart <- 
    all_data %>%
    select(cols)

data_kp_areachart$val_asstype <- fct_relevel(data_kp_areachart$val_asstype, c("NO", "OTHERS", "EFFICACY AND OTHERS", "EFFICACY"))

data_kp_areachart <- 
    data_kp_areachart %>%
    group_by(year, val_asstype) %>%  # first create counts for each group
    summarise(number_cases = n()) %>%
    mutate(total_cases_per_year = sum(number_cases),
           proportion = number_cases/total_cases_per_year,
           proportion_lbl = paste0(round(proportion*100,1), "%"))


# Not run
# display.brewer.all()
# display.brewer.pal(n = 6, name = "PRGn")
# brewer.pal(n = 6, name = "PRGn")[2:5]

# divergent palette instead of categorical (Set2). Get rid of edge values to avoid sharp contrast
pal <- brewer.pal(n = nlevels(data_kp_areachart$val_asstype)+2, name = "PRGn")[2:5]

kp_areachart <- 
    data_kp_areachart %>%
        ggplot(aes(x=year, y=proportion, fill=val_asstype)) + 
        geom_area() +
        labs(title="Temporal distribution of papers per assessment type",
        x="Year", 
        y="Percentage of paper  per assessment type", 
        caption="Source: authors") + 
        guides(fill=guide_legend(title="Assessment")) + # modify legend title
        scale_fill_manual(values = pal) +
        scale_y_continuous(expand=c(0,0), labels=scales::percent_format(accuracy = 1), breaks=seq(0, 1.00, by=0.20), limits=c(0, 1.00)) +
        theme_minimal() +
        theme(legend.title = element_text(size=11), 
              legend.position = "bottom",
              legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
              legend.key = element_blank()) +
        # Change the line type and color of axis lines
        theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid")) +
        theme(panel.grid.major = element_blank()) + 
        theme(panel.grid.minor = element_blank()) +
        theme(panel.background = element_blank()) +
        theme(plot.margin=unit(rep(20, 4), "pt"))

kp_areachart
kp_file_name <- "fig1_areachart.png"
ggsave(plot = kp_areachart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 20, height = 12, units = "cm", dpi = 600)

```


\newpage

### Figure 2 (barchart) - EXCLUDE FROM THE PAPER

Barchart: Distribution of papers per mental disorders, colored by assessment type.


```{r key_plot_1_barchart, echo=FALSE, dpi=600, fig.width=12, fig.asp=0.65}
data_kp_barchart <- 
    all_data %>%
    select(md, md_id, md_desc, val_asstype)

data_kp_barchart <- 
    data_kp_barchart %>% 
        group_by(md_id, md_desc, val_asstype) %>%  # first create counts for each group
        summarise(number_cases = n()) %>%
        mutate(proportion = number_cases/n_papers) %>% 
        ungroup() %>%
        group_by(md_id) %>%
        mutate(total_cases = sum(number_cases),
               proportion_sum = sum(proportion),
               proportion_lbl = paste0(round(proportion_sum*100,1), "%")) %>% 
        ungroup() %>%
        arrange(desc(proportion_sum), md_id)

# convert to factor to retain sorted order in plot.
data_kp_barchart$md_desc <- factor(data_kp_barchart$md_desc, levels=unique(data_kp_barchart$md_desc))  

data_kp_barchart$val_asstype <- fct_relevel(data_kp_barchart$val_asstype, c("NO", "OTHERS", "EFFICACY", "EFFICACY AND OTHERS"))

# Not run
# display.brewer.all()
# display.brewer.pal(n = 6, name = "PRGn")
# brewer.pal(n = 6, name = "PRGn")[2:5]

# divergent palette instead of categorical (Set2). Get rid of edge values to avoid sharp contrast
pal <- brewer.pal(n = nlevels(data_kp_barchart$val_asstype)+2, name = "PRGn")[2:5]

kp_barchart <- 
    data_kp_barchart %>%
      ggplot(aes(x=md_desc, y=number_cases, label=number_cases)) + #, fill=val_ass, group= val_ass)) +
        geom_bar(stat="identity", aes(fill=val_asstype), position = position_stack(reverse = T)) +
        geom_text(aes(label=number_cases, group=val_asstype), size=2, nudge_y=0.2) +
        labs(title=paste0("Distribution of papers per mental disorder (N=",n_papers,")"),
             x="Mental disorders", 
             y="Number of cases", 
             caption="Source: authors") + 
        coord_flip() +
        guides(fill=guide_legend(title="Assessment")) +  # modify legend title
        # scale_fill_brewer(palette = pal) + # Set2
        scale_fill_manual(values = pal) + 
        scale_y_continuous(expand=c(0,0), breaks=seq(0, 22, by=2), limits=c(0, 22)) +
        theme_minimal()  +
        # Legend: Top-Right Inside the Plot") 
        theme(legend.title = element_text(size=11), 
              legend.justification = c('right', 'top'),
              legend.position=c(0.95, 0.95),  
              #legend.background = element_blank(),
              legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
              legend.key = element_blank()) +
        # Change the line type and color of axis lines
        theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid")) +
        theme(panel.grid.major = element_blank()) + 
        theme(panel.grid.minor = element_blank()) +
        theme(panel.background = element_blank()) +
        theme(plot.margin=unit(rep(20, 4), "pt"))

kp_barchart
kp_file_name <- "fig2_barchart.png"
ggsave(plot = kp_barchart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 20, height = 12, units = "cm", dpi = 600)

```


### Figure 2 (IN)

Proportional barchart: Distribution of papers per mental disorders, colored by assessment type. Note that we draw two bars per mental disorder: one  represent no assessment, the other is a stack bar to show the split of assessment type 

```{r key_plot_2_barchart_bis, echo=FALSE,dpi=600,fig.width=12,fig.asp=0.65}
cols <- c("md", "md_id", "md_desc", "val_asstype")

data_kp_barchart <- 
    all_data %>%
    select(md, md_id, md_desc, val_asstype)

data_kp_barchart$val_asstype <- fct_relevel(data_kp_barchart$val_asstype, c("NO", "OTHERS", "EFFICACY AND OTHERS", "EFFICACY"))

data_kp_barchart <- 
    data_kp_barchart %>% 
        group_by(md_id, md_desc, val_asstype) %>%  # first create counts for each group
        summarise(number_cases = n()) %>%
        mutate(proportion = number_cases/n_papers) %>% 
        ungroup() %>%
        group_by(md_id) %>%
        mutate(total_cases = sum(number_cases),
               proportion_sum = sum(proportion),
               proportion_lbl = paste0(round(proportion_sum*100,1), "%")) %>% 
        ungroup() %>%
        arrange(desc(proportion_sum), md_id)

# convert to factor to retain sorted order in plot.
data_kp_barchart$md_desc <- factor(data_kp_barchart$md_desc, levels=unique(data_kp_barchart$md_desc))  

# Not run
# display.brewer.all()
# display.brewer.pal(n = 5, name = "PRGn")
# brewer.pal(n = 5, name = "PRGn")[2:5]
# divergent palette instead of categorical (Set2). Get rid of edge values to avoid sharp contrast
pal <- brewer.pal(n = nlevels(data_kp_barchart$val_asstype)+1, name = "PRGn")[1:3]

lbls <- distinct(data_kp_barchart, md_desc, proportion_sum, proportion_lbl)

top_proportion <- sum(lbls[1:6, "proportion_sum"]) 
top_lbl <- paste0(round(top_proportion*100,1), "%")

kp_barchart <- 
    data_kp_barchart %>%
      ggplot(aes(x=md_desc, y=proportion)) + 
        # Uncomment  for stacked barchart (option A) 
        #geom_bar(stat="identity", aes(fill=val_asstype)) +
        # Uncomment  for dodge barchart, single (option B) 
        geom_bar(stat="identity", aes(fill=val_asstype), position = position_dodge(preserve = "single")) + 
        # Uncomment  for dodge barchart, single (option C) 
        #geom_bar(stat="identity", aes(fill=val_asstype), position = position_dodge(preserve = "total")) + 
        labs(title=paste0("Distribution per mental disorder and assessment (N=",n_papers,")"), 
             subtitle = "Total percentatge per mental disorder within each point",
             x="Mental disorders", 
             y="Percentatge of papers [%]", 
             caption="Source: authors") + 
        geom_segment(aes(x=md_desc, y=0, xend=md_desc, yend=proportion_sum), color="grey50") +
        geom_point(aes(y=proportion_sum), size=6, color="lightgrey") +
        # Percentatge inside point
        annotate("text", x = lbls$md_desc, y = lbls$proportion_sum,
                 label = lbls$proportion_lbl, color = "black", size=2, hjust = 0.4, vjust = 0.2) +
        # Arrow to indidate  Top6 mental disorders 
        annotate("text", x = "Schizophrenia spectrum and other psychotic disorders", y = .17,
                 label = top_lbl, color = "black", size = 3, hjust = -0.1, vjust = 1.2) +
        geom_segment(aes(x = "Schizophrenia spectrum and other psychotic disorders", 
                         xend = "Substance-related and addictive disorders", 
                         y = .19, 
                         yend = .19),
                         arrow = arrow(length = unit(0.5,"cm")), color = "black") +
        geom_segment(aes(x="Schizophrenia spectrum and other psychotic disorders", 
                         y=0.16, 
                         xend="Schizophrenia spectrum and other psychotic disorders", 
                         yend=0.19), color="black") +
        coord_flip() +
        guides(fill=guide_legend(title="Assessment")) +  # modify legend title
        # scale_fill_brewer(palette = "Set2") +
        scale_fill_manual(values = pal) + 
        scale_y_continuous(expand=c(0,0), labels=scales::percent_format(accuracy = 1), breaks=seq(0, 0.21, by=0.02), limits=c(0, 0.21)) +
        theme_minimal()  +
        # Legend: Top-Right Inside the Plot") 
        theme(legend.title = element_text(size=11), 
              legend.justification = c('right', 'top'),
              legend.position=c(0.95, 0.95),  
              #legend.background = element_blank(),
              legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
              legend.key = element_blank()) +
        # Change the line type and color of axis lines
        theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid")) +
        theme(panel.grid.major = element_blank()) + 
        theme(panel.grid.minor = element_blank()) +
        theme(panel.background = element_blank()) +
        theme(plot.margin=unit(rep(20, 4), "pt"))

kp_barchart
kp_file_name <- "fig2_barchart_proportion_b.png"
ggsave(plot = kp_barchart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 21, height = 20, units = "cm", dpi = 600)


```


\newpage

### Figure 2 (linechart)

Linechart: Distribution of papers (Total and top6 mental disorders) per year.


```{r key_plot_2_linechart, echo=FALSE, dpi=600, fig.width=12, fig.height=14, fig.asp=0.65}

top <- levels(all_data$md)[1:6]

prediction_2018 <- 52

data_total_byyear <- 
    all_data %>% 
    group_by(year) %>%  # first create counts for each group
    summarise(number_cases = n()) %>%
    mutate(md_desc = c("All"))


data_top_byyear <- 
    all_data %>%
      filter(md %in% top) %>%
      group_by(md_desc, year) %>%
      summarise(number_cases = n()) %>%
      bind_rows(data_total_byyear) %>%
      ungroup() %>%
      mutate(md_desc = factor(md_desc)) %>%
      arrange(desc(number_cases))

# https://www.r-graph-gallery.com/portfolio/ggplot2-package/
# https://ggplot2.tidyverse.org/reference/position_stack.html

data_top_byyear$md_desc <- fct_relevel(data_top_byyear$md_desc, 
                                       c("All", "Depressive disorders", "Various", "Anxiety disorders", 
                                         "Trauma and stressor-related disorders",
                                         "Substance-related and addictive disorders",
                                         "Schizophrenia spectrum and other psychotic disorders"))
brks <- levels(data_top_byyear$md_desc) 
    
kp_linechart <-
    data_top_byyear %>%
        ggplot(aes(x=year, y=number_cases, group=md_desc)) +
        geom_vline(aes(xintercept = 2017), color="lightgray", linetype = "dashed", size = 0.5) +
        annotate("rect", xmin = 2017, xmax = 2018, ymin = -Inf, ymax = +Inf, fill = "lightgray", alpha = 0.2) +
        geom_line(aes(color=md_desc), size=1, alpha=.4) +
        # prediction all papers in 2018
        geom_segment(aes(x=2017,
                         y=39,
                         xend=2018,
                         yend=prediction_2018), color="darkgray", linetype=2) +
        geom_point(aes(color=md_desc), size=6) +
        labs(title="Distribution top mental disorders per year", 
             subtitle = paste0("All vs. top mental disorders (", top_lbl,"). Dashed line denotes extrapolation for 2018"),
             x="Year", 
             y="Number of cases", 
             caption="Source: authors") + 
        scale_color_brewer(palette="Set2", breaks=brks) +
        geom_text(aes(label = number_cases), color= "white", size=3) +
        # prediction all papers in 2018
        # geom_point(x=2018, y=prediction_2018, color="darkgray", size=6) +
        # annotate("text", x =2018, y = prediction_2018,
        #          label = prediction_2018, color = "black", size=3) +
        theme_minimal() +
        theme(legend.title = element_blank()) +
        # Legend: Top-Right Inside the Plot") 
        theme(legend.justification = c('left', 'top'),
              legend.position=c(0.05, 0.95),  
              #legend.background = element_blank(),
              legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
              legend.key = element_blank()) +
        theme(panel.grid.major = element_blank()) + 
        theme(panel.grid.minor = element_blank()) +
        theme(panel.background = element_blank()) +
        theme(plot.margin=unit(rep(20, 4), "pt")) +
        # Change the line type and color of axis lines
        theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid"))

kp_linechart
kp_file_name <- "fig2_linechart_b.png"
ggsave(plot = kp_linechart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 20, height = 18, units = "cm", dpi = 600) 


```

\newpage

### Figure 3 (Tables + circular barplot)

Table (Example 1): Distribution of papers (apps) per mental disorder.  _How many apps are related to each mental disorder?_ Per each mental disorder, assessment (yes/no) and year, we show the paper id and appname.


```{r key_plot_3_table1, echo=FALSE}

# library(formattable)

kp_file_name <- here::here("figs", "table1.html")
#' Example  1, verbose table
data_kp_apps <- 
    all_data %>%
    # filter(as.integer(md_id) < 6) %>%
    # group_by(val_ass) %>%
    # summarise(number_apps = n()) 
    # mutate(val_ass = color_tile("white", "orange")(val_ass)) %>%
    arrange(md_id, val_ass, year, id)

#' source: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html

# options(knitr.kable.NA = '-')
data_kp_apps %>%
    select(`Mental Disorder` = md,
           `Assessment` = val_ass,
           `Year` = year,
           `Paper id` = id,
           `App Name` = app_name) %>%
    kable(format="html", escape = T, booktabs = TRUE,
          caption =  paste0("Distribution of papers (apps) per mental disorder\n",
                            "'NA' is app not specified/available")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:3, valign = "top") #%>%  
    # save_kable(file = kp_file_name, self_contained = T)

```
Table (Example 2): _Compact_ distribution of papers (apps) per mental disorder, grouping the references per app. The mumber(s) in brackets next to the app name is the reference(s) in which the app is mentioned. 


```{r key_plot_3_table2, echo=FALSE}

kp_file_name <- here::here("figs", "table2.html")

unite_paper_ids <- function(mentaldisorder, appname) {
    if (!is.na(appname)) {
        all_data %>% 
            filter(md == mentaldisorder & app_name==appname) %>%
            arrange(year) %>%
            select(id) %>%
            as_vector() %>%
            stringr::str_c(collapse = ";")    
    } else {
         all_data %>% 
            filter(md == mentaldisorder & is.na(app_name)) %>%
            arrange(year) %>%
            select(id) %>%
            as_vector() %>%
            stringr::str_c(collapse = ";")  
    }
}

data_kp_apps2 <- 
    all_data %>%
    # filter(as.integer(md_id) < 6) %>%
    group_by(md, app_name) %>%
    summarise(number_apps = n()) %>% 
    # mutate(val_ass = color_tile("white", "orange")(val_ass)) %>%
    arrange(md, number_apps)

data_kp_apps2 <- 
    data_kp_apps2 %>%
    add_column(ids = purrr::map2(data_kp_apps2$md, data_kp_apps2$app_name, unite_paper_ids))

data_kp_apps2 <- 
    data_kp_apps2 %>%
    add_column(app_ids = paste0(data_kp_apps2$app_name, " (", data_kp_apps2$ids, ")"))

data_kp_apps2 <- 
    data_kp_apps2 %>%
    group_by(md) %>%
    summarise(app_ids_merge = paste0(app_ids, collapse = ", ")) %>%
    arrange(desc(md))

# options(knitr.kable.NA = '-')
# data_kp_apps2_kable <-
data_kp_apps2 %>%
    select(`Mental Disorder` = md,
           `References by app` = app_ids_merge) %>%
    kable(formt="html", escape = T, booktabs = TRUE,    
          caption = paste0("Compact distribution of papers (apps) per mental disorder\n", 
                            "'NA' is app not specified/available")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1, valign = "top") #%>%  
    # save_kable(file = kp_file_name, self_contained = T)


```

Circular barplot (Example 3): Each cell means one occurence of the app in a paper.

```{r key_plot_3_table3, echo=FALSE}

#' source: https://www.r-graph-gallery.com/297-circular-barplot-with-groups/

data_kp_apps3 <- 
    all_data %>%
    filter(as.integer(md_id) != 26) %>%
    group_by(app_name, md_desc) %>%
    summarise(number_apps = n()) %>% 
    arrange(md_desc, number_apps)

data_kp_apps3$app_name <- fct_explicit_na(data_kp_apps3$app_name, "Not App Available")
data_kp_apps3$id <- seq(1, nrow(data_kp_apps3))


# source: https://www.r-bloggers.com/how-to-expand-color-palette-with-ggplot-and-rcolorbrewer/
n_colors <- length(unique(data_kp_apps3$md_desc))
get_palette <- colorRampPalette(brewer.pal(8, "Set1"))


# Get the name and the y position of each label
label_data=data_kp_apps3
number_of_bar=nrow(label_data)
angle= 90 - 360 * (label_data$id-0.5)/number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust<-ifelse(angle < -90, 1, 0)
label_data$angle<-ifelse(angle < -90, angle+180, angle)

# Make the plot
kp_circularbarplot <- 
    ggplot(data_kp_apps3, aes(x=as.factor(id), y=number_apps, fill=md_desc)) +  
      geom_bar(stat="identity", alpha=0.5) +
      # Lmits of the plot: The negative value controls the size of the inner circle, the positive one is useful to add size over each bar
      ylim(-5,10) +
      scale_fill_manual(values = get_palette(n_colors), name="Mental disorders") +
      scale_color_manual(values = get_palette(n_colors)) +    
      theme_minimal() +
      theme(
        legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size=5),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        plot.margin = unit(rep(-1,4), "cm")
      ) +
      guides (fill = guide_legend(ncol=1)) +    
      coord_polar(start=0) + 
      geom_text(data=label_data, aes(x=id, y=number_apps, label=app_name, hjust=hjust, color=md_desc), 
                alpha=0.6, size=3, angle= label_data$angle, inherit.aes = FALSE, show.legend = FALSE ) +
      geom_hline(yintercept = seq(1:10), col = "white", lwd=0.5)

kp_circularbarplot

kp_file_name <- "fig_circularbarplot.png"
ggsave(plot = kp_circularbarplot, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 25, height = 25, units = "cm", dpi = "print") #300


```

```{r echo=FALSE}

#' circlize, source: http://jokergoo.github.io/circlize/example/bi_directional.html
# library(circlize)
# 
# appnames <- unique(data_kp_apps3$app_name)
# fappnames <- factor(data_kp_apps3$app_name, levels = appnames)    
# 
# circos.clear()
# circos.initialize(factors = fappnames, x = appnames)
# 
# factors = appnames[1:4] #letters[1:4]
# circos.initialize(factors = factors, xlim = c(0, 1))
# circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
#     circos.points(1:20/20, 1:20/20)
# })
# text(0, 0, "This is\nthe center", cex = 1.5)
# legend("bottomleft", pch = 1, legend = "This is the legend")
# title("This is the title")
# 
# 
# col_fun = colorRamp2(c(-2, 0, 2), c("green", "yellow", "red"))
# 
# circlize_plot = function() {
#     set.seed(12345)
#     fa <- appnames[1:10]
#     n <- length(fa)
#     circos.initialize(factors = fa, xlim = c(0, 1))
#     circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
#         circos.points(runif(20), runif(20), cex = 0.5, pch = 16, col = 2)
#         circos.points(runif(20), runif(20), cex = 0.5, pch = 16, col = 3)
#     })
#     circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
#         circos.lines(sort(runif(20)), runif(20), col = 4)
#         circos.lines(sort(runif(20)), runif(20), col = 5)
#     })
# 
#     for(i in n) {
#         circos.link(sample(fa, 1), sort(runif(10))[1:2], 
#                     sample(fa, 1), sort(runif(10))[1:2],
#                     col = add_transparency(col_fun(rnorm(1))))
#     }
#     circos.clear()
# }
# 
# circlize_plot()
# 
# 
# 
# set.seed(999)
# mat <- matrix(sample(18, 18), 3, 6) 
# rownames(mat) <- paste0("S", 1:3)
# colnames(mat) <- paste0("E", 1:6)
# mat
# 
# 
# df <- data.frame(from = rep(rownames(mat), times = ncol(mat)),
#     to = rep(colnames(mat), each = nrow(mat)),
#     value = as.vector(mat),
#     stringsAsFactors = FALSE)
# 
# df
# 
# 
# circos.par(start.degree = 90, track.margin = c(-0.1, 0.1), gap.degree = 4, points.overflow.warning = FALSE)
# chordDiagram(df)
# circos.clear()


```

\newpage

### Figure 4 (Bubble plot) - TODO

Bubble plot: Distribution of papers per mental disorder and technology variables (sensor capabilities and features)

```{r key_plot_4_bubblechart, echo=FALSE, dpi=600, fig.width=12, fig.height=14, fig.asp=0.65}
# Sensory capabilities related to each mental disorder 
cols = c("id", "md", "md_id", "md_desc", "md_sub",
         "sens_acc", "sens_gyr", "sens_gps", "sens_mic",
         "os_ios", "os_and", "app_name",
         "type", "year")


data_kp_sens <- 
    all_data %>%
    select(cols) %>%
    arrange(md_desc, md_sub)
    # group_by(md_desc, md_sub) %>%
    # summarise(number_apps = n())

#' source: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
data_kp_sens %>%
    # mutate(sens_acc = cell_spec(sens_acc, color = ifelse(sens_acc=="YES", "blue", "red"))) %>%
    select(`DSM-5 Mental Disorder` = md_desc,
           `MD Subtype` = md_sub,
           `Accelerometer` = sens_acc,
           `Ggyroscope` = sens_gyr,
           `GPS` = sens_gps,
           `Microphone` = sens_mic,
           `App Name` = app_name) %>%
    kable(format = "html", escape = FALSE) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```






