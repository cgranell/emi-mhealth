---
title: 'Analysis and visualisations for "<JMIR paper title here>"'
author: "Carlos GRanell "
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    keep_tex: yes
    #latex_engine: xelatex
    toc: yes
  html_document:
    df_print: paged
    toc: yes
urlcolor: blue    
---

## License

This document is licensed under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/).


## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)
library(ggalt)
library(scales)
#library(easyalluvial)
library(RColorBrewer)
library(gridExtra)
library(treemap)
library(forcats)
library(purrr)

```


```{r session_info, echo=FALSE}
# devtools::session_info(include_base = TRUE)
```

This R notebook contains the code to produce the final figures of the paper.

## Data 

We analyse three datasets of the *emidata* package: 

* *ipapers2018_psydata* (extracted data items related to psychology) has `` `r nrow(ipapers2018_psydata)` `` records and `` `r ncol(ipapers2018_psydata)` `` columns.
* *ipapers2018_csdata* (extracted data items related to tech/cs) has `` `r nrow(ipapers2018_csdata)` `` records and `` `r ncol(ipapers2018_csdata)` `` columns. 
* *ipapers2018* (list of analysed papers) has `` `r nrow(ipapers2018)` `` records and `` `r ncol(ipapers2018)` `` columns.

```{r data_source, echo=FALSE}
cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata
```


```{r all_data, echo=FALSE}

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop "included" columns
all_data <- all_data %>% select(-id_csin, -id_psyin)

all_data <- all_data %>%
    inner_join(ipapers2018, by="id") %>%
    select(-filename, -title, -abstract, -journal, -author, -keywords)

# cast MD to factor
all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

#' Merge two factors levels into a new one "26-Various" 
all_data$md <- 
    all_data$md %>% 
    fct_collapse("26-Various" = c("23-Duo","24-Multiple"))

#' Sync changes of "md" to other two columns, "md_id"" and "md_desc""
all_data <- 
    all_data %>% 
        separate(md, c("md_id","md_desc"), "-", extra="merge", remove=FALSE)

all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

n_md <- nlevels(all_data$md)
n_papers = nrow(all_data)

category_levels <- c("YES","NO")
all_data <- 
    all_data %>%
    mutate(md_dsm5 = factor(if_else(md_id <= 22, "YES", "NO"), levels=category_levels))

n_yes_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "YES") %>%
        nrow()

n_no_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "NO") %>%
        nrow()

```

The final number of papers to analyse is `` `r n_papers` ``.

There are `` `r n_md` `` distinct MDs (out of 25). About `r percent(n_yes_dsm5/n_papers)` (N=`r n_yes_dsm5`) are categorised according to Section II of  [DSM-5 manual](https://dsm.psychiatryonline.org/doi/book/10.1176/appi.books.9780890425596). About `r percent(n_no_dsm5/n_papers)` (N=`r n_no_dsm5`) are 23-Dual, 24-Multiple or 25-Suicidal behavior disorder/nonsuicidal self-injury. 


\newpage

## Key figures


### Figure 1  

Barchart: Distribution of papers per mental disorders, colored by assessment (yes/no).


```{r key_plot_1_barchart, echo=FALSE}

data_kp_barchart <- 
    all_data %>%
    select(md, md_id, md_desc, val_ass)

data_kp_barchart <- 
    data_kp_barchart %>% 
        group_by(md_id, md_desc, val_ass) %>%  # first create counts for each group
        summarise(number_cases = n()) %>%
        # Create total counts and proportions per mental disorder
        group_by(md_desc) %>%
        mutate(total_cases = sum(number_cases),
               proportion = number_cases/total_cases) %>% 
        ungroup() %>%
        arrange(desc(total_cases), md_id)


# convert to factor to retain sorted order in plot.
data_kp_barchart$md_desc <- factor(data_kp_barchart$md_desc, levels=unique(data_kp_barchart$md_desc))  

kp_barchart <- 
    data_kp_barchart %>%
      ggplot(aes(x=md_desc, y=number_cases, label=number_cases)) + #, fill=val_ass, group= val_ass)) +
        geom_bar(stat="identity", aes(fill = val_ass), position = position_stack(reverse = T)) +
        geom_text(aes(label=number_cases), size=2, nudge_y = 0.2) +
        labs(title="Distribution of papers per mental disorder", 
             subtitle = paste0("(N=",n_papers, ")"),
             x="Mental disorders", 
             y="Number of cases", 
             caption="Source: authors") + 
        coord_flip() +
        guides(fill=guide_legend(title="Assessment")) +  # modify legend title
        scale_fill_brewer(palette = "Set2") +
        scale_y_continuous(expand=c(0,0), breaks=seq(0, 22, by=2), limits=c(0, 22)) +
        theme_minimal()  +
        # Legend: Top-Right Inside the Plot") 
        theme(legend.title = element_text(size=11), 
              legend.justification = c('right', 'top'),
              legend.position=c(0.95, 0.95),  
              #legend.background = element_blank(),
              legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
              legend.key = element_blank()) +
        # Change the line type and color of axis lines
        theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid")) +
        theme(panel.grid.major = element_blank()) + 
        theme(panel.grid.minor = element_blank()) +
        theme(panel.background = element_blank()) +
        theme(plot.margin=unit(rep(20, 4), "pt"))

kp_barchart
kp_file_name <- "fig_barchart.png"
ggsave(plot = kp_barchart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 20, height = 12, units = "cm", dpi = "print") #300


```

Alternatively to the barchart

```{r key_plot_1_lollipop, echo=FALSE}

md_percent <- 
    all_data %>%
      group_by(md, md_desc) %>%
      summarise(n = n()) %>%
      mutate(proportion = n/n_papers) %>%
      arrange(desc(n))

md_percent %>%
    ggplot(aes(y=reorder(md_desc, proportion), x=proportion)) +
    geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
    scale_x_continuous(expand=c(0,0), labels=scales::percent_format(accuracy = 1), breaks=seq(0, 0.20, by=0.02), limits=c(0, 0.20)) +
    theme_minimal() +
    labs(title="Proportional distribution of mental disorders",
         subtitle=paste0("(N=",n_papers, ")"),
         x="Percentage",
         y="Mental disorders",
         caption="Source: authors") +
    theme(panel.grid.major.y=element_blank()) +
    theme(panel.grid.minor=element_blank()) +
    theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
    theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
    theme(plot.margin=unit(rep(20, 4), "pt")) +
    theme(plot.subtitle=element_text(margin=margin(b=10)))

```

\newpage

### Figure 2

Linechart: Distribution of papers (Total and top3 mental disorders) per year.


```{r key_plot_2_linechart, echo=FALSE}

top3 <- levels(all_data$md)[1:3]

data_total_byyear <- 
    all_data %>% 
    group_by(year) %>%  # first create counts for each group
    summarise(number_cases = n()) %>%
    mutate(md_desc = c("All"))


data_top3_byyear <- 
    all_data %>%
      filter(md %in% top3) %>%
      group_by(md_desc, year) %>%
      summarise(number_cases = n()) %>%
      bind_rows(data_total_byyear) %>%
      ungroup() %>%
      mutate(md_desc = factor(md_desc)) %>%
      arrange(desc(number_cases))

# https://www.r-graph-gallery.com/portfolio/ggplot2-package/
# https://ggplot2.tidyverse.org/reference/position_stack.html

data_top3_byyear$md_desc <- fct_relevel(data_top3_byyear$md_desc, c("All", "Depressive disorders", "Various", "Anxiety disorders"))
brks <- levels(data_top3_byyear$md_desc) 
    
kp_linechart <-
data_top3_byyear %>%
    ggplot(aes(x=year, y=number_cases, group=md_desc)) +
    geom_line(aes(color=md_desc), size=1, alpha=.4) +
    geom_point(aes(color=md_desc), size=6) +
    labs(title="Distribution of papers per year", 
         subtitle = "Total and top3 mental disorders",
         x="Year", 
         y="Number of cases", 
         caption="Source: authors") + 
    scale_color_brewer(palette="Set2", breaks=brks) +
    geom_text(aes(label = number_cases), color= "white", size=3) +
    geom_vline(aes(xintercept = 2017), color="darkgray", linetype = "dashed", size = 0.5) +
    annotate("rect", xmin = 2017, xmax = 2018, ymin = -Inf, ymax = +Inf, fill = "lightgray", alpha = 0.2) +
    theme_minimal() +
    theme(legend.title = element_blank()) +
    # Legend: Top-Right Inside the Plot") 
    theme(legend.justification = c('left', 'top'),
          legend.position=c(0.05, 0.95),  
          #legend.background = element_blank(),
          legend.background = element_rect(color = "darkgray", size = 0.5, linetype ="solid"),
          legend.key = element_blank()) +
    theme(panel.grid.major = element_blank()) + 
    theme(panel.grid.minor = element_blank()) +
    theme(panel.background = element_blank()) +
    theme(plot.margin=unit(rep(20, 4), "pt")) +
    # Change the line type and color of axis lines
    theme(axis.line = element_line(colour = "darkgray", size = 0.5, linetype = "solid"))

kp_linechart
kp_file_name <- "fig_linechart.png"
ggsave(plot = kp_linechart, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 20, height = 12, units = "cm", dpi = "print") #300


```

\newpage

### Figure 3 (Table)

Table (Example 1): Distribution of papers (apps) per mental disorder.  _How many apps are related to each mental disorder?_ Per each mental disorder, assessment (yes/no) and year, we show the paper id and appname.


```{r key_plot_3_table1, echo=FALSE}

# library(formattable)

kp_file_name <- here::here("figs", "table1.html")
#' Example  1, verbose table
data_kp_apps <- 
    all_data %>%
    filter(as.integer(md_id) < 6) %>%
    # group_by(val_ass) %>%
    # summarise(number_apps = n()) 
    # mutate(val_ass = color_tile("white", "orange")(val_ass)) %>%
    arrange(md_id, val_ass, year, id)

#' source: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html

# options(knitr.kable.NA = '-')
data_kp_apps %>%
    select(`Mental Disorder` = md,
           `Assessment` = val_ass,
           `Year` = year,
           `Paper id` = id,
           `App Name` = app_name) %>%
    kable(format="html", escape = T, booktabs = TRUE,
          caption =  paste0("Distribution of papers (apps) per mental disorder\n",
                            "'NA' is app not specified/available")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1:3, valign = "top") #%>%  
    # save_kable(file = kp_file_name, self_contained = T)

```
Table (Example 2): _Compact_ distribution of papers (apps) per mental disorder, grouping the references per app.


```{r key_plot_3_table2, echo=FALSE}

kp_file_name <- here::here("figs", "table2.html")

unite_paper_ids <- function(mentaldisorder, appname) {
    if (!is.na(appname)) {
        all_data %>% 
            filter(md == mentaldisorder & app_name==appname) %>%
            arrange(year) %>%
            select(id) %>%
            as_vector() %>%
            stringr::str_c(collapse = ";")    
    } else {
         all_data %>% 
            filter(md == mentaldisorder & is.na(app_name)) %>%
            arrange(year) %>%
            select(id) %>%
            as_vector() %>%
            stringr::str_c(collapse = ";")  
    }
}

data_kp_apps2 <- 
    all_data %>%
    filter(as.integer(md_id) < 6) %>%
    group_by(md, app_name) %>%
    summarise(number_apps = n()) %>% 
    # mutate(val_ass = color_tile("white", "orange")(val_ass)) %>%
    arrange(md, number_apps)

data_kp_apps2 <- 
    data_kp_apps2 %>%
    add_column(ids = purrr::map2(data_kp_apps2$md, data_kp_apps2$app_name, unite_paper_ids))

data_kp_apps2 <- 
    data_kp_apps2 %>%
    add_column(app_ids = paste0(data_kp_apps2$app_name, " (", data_kp_apps2$ids, ")"))

data_kp_apps2 <- 
    data_kp_apps2 %>%
    group_by(md) %>%
    summarise(app_ids_merge = paste0(app_ids, collapse = ", ")) %>%
    arrange(desc(md))

# options(knitr.kable.NA = '-')
# data_kp_apps2_kable <-
data_kp_apps2 %>%
    select(`Mental Disorder` = md,
           `References by app` = app_ids_merge) %>%
    kable(formt="html", escape = T,
          caption = paste0("Compact distribution of papers (apps) per mental disorder\n", 
                            "'NA' is app not specified/available")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
    column_spec(1, bold = T) %>%
    collapse_rows(columns = 1, valign = "top") #%>%  
    # save_kable(file = kp_file_name, self_contained = T)


# data_kp_apps2_kable
# library(magick)
# install.packages("magick")
# kable_as_image(data_kp_apps2_kable, filename = kp_file_name, file_format = "png",
#   latex_header_includes = NULL, keep_pdf = FALSE, density = 300,
#   keep_tex = FALSE)
# 

```

Circular barplot (Example 3): Emphasis on links between apps, i.e., when the same app is used in distinct mental disorder.

```{r key_plot_3_table3, echo=FALSE}

#' circlize, source: http://jokergoo.github.io/circlize/example/bi_directional.html
#' source: https://www.r-graph-gallery.com/297-circular-barplot-with-groups/
library(circlize)

data_kp_apps3 <- 
    all_data %>%
    filter(as.integer(md_id) != 26) %>%
    group_by(app_name, md_desc) %>%
    summarise(number_apps = n()) %>% 
    arrange(md_desc, number_apps)

data_kp_apps3$app_name <- fct_explicit_na(data_kp_apps3$app_name, "Not App Available")
data_kp_apps3$id <- seq(1, nrow(data_kp_apps3))


# source: https://www.r-bloggers.com/how-to-expand-color-palette-with-ggplot-and-rcolorbrewer/
n_colors <- length(unique(data_kp_apps3$md_desc))
get_palette <- colorRampPalette(brewer.pal(8, "Set1"))


# Get the name and the y position of each label
label_data=data_kp_apps3
number_of_bar=nrow(label_data)
angle= 90 - 360 * (label_data$id-0.5)/number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust<-ifelse(angle < -90, 1, 0)
label_data$angle<-ifelse(angle < -90, angle+180, angle)

# Make the plot
kp_circularbarplot <- 
    ggplot(data_kp_apps3, aes(x=as.factor(id), y=number_apps, fill=md_desc)) +  
      geom_bar(stat="identity", alpha=0.5) +
      # Lmits of the plot: The negative value controls the size of the inner circle, the positive one is useful to add size over each bar
      ylim(-5,10) +
      scale_fill_manual(values = get_palette(n_colors), name="Mental disorders") +
      scale_color_manual(values = get_palette(n_colors)) +    
      theme_minimal() +
      theme(
        legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size=5),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        plot.margin = unit(rep(-1,4), "cm")
      ) +
      guides (fill = guide_legend(ncol=1)) +    
      coord_polar(start=0) + 
      geom_text(data=label_data, aes(x=id, y=number_apps, label=app_name, hjust=hjust, color=md_desc), 
                alpha=0.6, size=3, angle= label_data$angle, inherit.aes = FALSE, show.legend = FALSE ) +
      geom_hline(yintercept = seq(1:10), col = "white", lwd=0.5)

kp_circularbarplot

kp_file_name <- "fig_circularbarplot.png"
ggsave(plot = kp_circularbarplot, filename = kp_file_name, device = "png", path = here::here("figs"),
    scale = 1, width = 25, height = 25, units = "cm", dpi = "print") #300


```

```{r echo=FALSE}

appnames <- unique(data_kp_apps3$app_name)
fappnames <- factor(data_kp_apps3$app_name, levels = appnames)    

circos.clear()
circos.initialize(factors = fappnames, x = appnames)

factors = appnames[1:4] #letters[1:4]
circos.initialize(factors = factors, xlim = c(0, 1))
circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
    circos.points(1:20/20, 1:20/20)
})
text(0, 0, "This is\nthe center", cex = 1.5)
legend("bottomleft", pch = 1, legend = "This is the legend")
title("This is the title")




col_fun = colorRamp2(c(-2, 0, 2), c("green", "yellow", "red"))

circlize_plot = function() {
    set.seed(12345)
    fa <- appnames[1:10]
    n <- length(fa)
    circos.initialize(factors = fa, xlim = c(0, 1))
    circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
        circos.points(runif(20), runif(20), cex = 0.5, pch = 16, col = 2)
        circos.points(runif(20), runif(20), cex = 0.5, pch = 16, col = 3)
    })
    circos.track(ylim = c(0, 1), panel.fun = function(x, y) {
        circos.lines(sort(runif(20)), runif(20), col = 4)
        circos.lines(sort(runif(20)), runif(20), col = 5)
    })

    for(i in n) {
        circos.link(sample(fa, 1), sort(runif(10))[1:2], 
                    sample(fa, 1), sort(runif(10))[1:2],
                    col = add_transparency(col_fun(rnorm(1))))
    }
    circos.clear()
}

circlize_plot()



set.seed(999)
mat <- matrix(sample(18, 18), 3, 6) 
rownames(mat) <- paste0("S", 1:3)
colnames(mat) <- paste0("E", 1:6)
mat


df <- data.frame(from = rep(rownames(mat), times = ncol(mat)),
    to = rep(colnames(mat), each = nrow(mat)),
    value = as.vector(mat),
    stringsAsFactors = FALSE)

df


circos.par(start.degree = 90, track.margin = c(-0.1, 0.1), gap.degree = 4, points.overflow.warning = FALSE)
chordDiagram(df)
circos.clear()

# data_kp_apps <- 
#     all_data %>%
#     group_by(md_id, md_desc) %>%
#     #drop_na(md_sub)%>%
#     summarise(number_apps = n()) 
# 
# data_kp_apps %>%
#   ggplot(aes(x=md_desc, y=number_apps, fill=factor(md_id))) + 
#   geom_bar(stat="identity") +
#   coord_flip() + 
#   labs(title="Apps per subtopic coloured by MD",
#        subtitle = "Absolute count") +
#   theme(legend.position = "top") +
#   theme_minimal()


```


### Figure 4


Bubble plot: Distribution fo apper per mental disorder and technolgy variables (sensor capabilities and features)


### Sensory capabilities related to each MD 

```{r md_apps_table, echo=FALSE}
cols = c("id", "md", "md_id", "md_desc", "md_sub", "md_dsm5",
         "sens_acc", "sens_gyr", "sens_gps", "sens_mic", 
         "os_ios", "os_and", "app_name", 
         "type", "year")

sens_apps <- 
    all_data %>% 
    filter(md_id!=23 & md_id!=24) %>%
    select(cols) %>%
    arrange(md_desc, md_sub)
    # group_by(md_desc, md_sub) %>%
    # summarise(number_apps = n()) 


#' source: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
sens_apps %>%
    # mutate(sens_acc = cell_spec(sens_acc, color = ifelse(sens_acc=="YES", "blue", "red"))) %>%
    select(`DSM-5 Mental Disorder` = md_desc,
           `MD Subtype` = md_sub,
           `Accelerometer` = sens_acc,
           `Ggyroscope` = sens_gyr,
           `GPS` = sens_gps,
           `Microphone` = sens_mic,
           `App Name` = app_name) %>%
    kable(format = "html", escape = FALSE) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```






