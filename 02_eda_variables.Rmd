---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)

```


```{r session_info, echo=FALSE}
devtools::session_info(include_base = TRUE)
```

This document is an EDA notebook to explore descriptive and informative figures of the datasets incldued in the *emidata* package.  

## Data 

We analyse three  datasets: *ipapers2018_csdata* dataset (psy-realted data items) has `` `r nrow(ipapers2018_csdata)` `` records, *ipapers2018_psydata* dataset (cs-related data items) that has `` `r nrow(ipapers2018_psydata)` `` records, and *ipapers2018*  dataset (analysed papers) with `` `r nrow(ipapers2018)` `` records.

```{r data_source, echo=FALSE}
cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata
cs_data %>% glimpse()
cs_data %>% skimr::skim()
psy_data %>% glimpse()
psy_data %>% skimr::skim()

```


```{r all_data, echo=FALSE}

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop misused columns
all_data <- all_data %>% select(-id_csin, -id_psyin)

total_papers = nrow(all_data)
```

The final number of papers to analyse is `` `r total_papers` ``.

## Exploratory analysis

Next tables and figures are exploratory to figure out what's going on. The initial assumption of the apper is that the mental disorders field (*md*) drives the analysis. So we start exploring the variables related to mental disorders: 

```{r md_variables, echo=TRUE}
all_data %>%
    select(starts_with("md")) %>%
    names()

```

### Mental disorders (MDs) variable 

_How many ditinct MDs are there?_ 

```{r md_variability, echo=FALSE}

md_data <- 
    all_data %>%
    select(starts_with("md"))

md_data$md <- factor(md_data$md, levels=names(sort(table(md_data$md), decreasing=T)))
n_md <- nlevels(md_data$md)

md_data <- 
    md_data %>%
    mutate(md_dsh5 = factor(if_else(md_id <= 22, "YES", "NO")))

n_yes_dsh5 <- 
    md_data %>%
        filter(md_dsh5 == "YES") %>%
        nrow()
n_no_dsh5 <- 
    md_data %>%
        filter(md_dsh5 == "NO") %>%
        nrow()

md_data %>% str() 


```

There are `` `r n_md` `` distinct MDs (out of 25). About `r round(n_yes_dsh5/n_md * 100)` % (`r n_yes_dsh5`) are categorised according to DSH-5. 
About `r round(n_no_dsh5/n_md * 100)` % (`r n_no_dsh5`) are Dual, Multiple or Suicidal Behavior Disorder/Nonsuicidal Self-Injury. 


```{r plot_md_variability, echo=FALSE}
# plot variety of mental disorders

md_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsh5)) +
    geom_bar() +
    coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    theme_bw()

```

_top 3 MDs_? 

```{r md_plot3, echo=FALSE}
top3 <- levels(md_data$md)[1:3]

n_top3 <- 
    md_data %>%
        filter(md %in% top3) %>%
        nrow()

md_data %>%
  filter(md %in% top3) %>%
  group_by(md) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

```




```{r todo}

md_data %>%
ggplot(mapping = aes(x = md, y = n, fill = md_dsh5)) +
    geom_bar(stat="identity") +
    coord_flip() +
    geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
    theme_bw()


geom_text(stat = 'count' ,aes(label = ..count..),
nudge_y = 1.5)


md_data %>%
  group_by(md) %>%
  summarise(n = n()) %>%
  arrange(desc(n))  %>%
  ggplot(mapping = aes(x = md, y = n)) +
    geom_bar(stat="identity", fill="orange") +
    coord_flip() +
    geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
    theme_bw()

```


### BELOW THIS LINE IS NOT VALID



## Search terms in the abstract

### Psychological terms


_How often do psychological related search terms appear in each abstract?_


