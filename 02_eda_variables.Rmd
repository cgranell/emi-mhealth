---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)
library(ggalt)
library(scales)

```


```{r session_info, echo=FALSE}
#devtools::session_info(include_base = TRUE)
```

This document is an EDA notebook to explore descriptive and informative figures of the datasets incldued in the *emidata* package.  

## Data 

We analyse three  datasets: *ipapers2018_csdata* dataset (psy-realted data items) has `` `r nrow(ipapers2018_csdata)` `` records, *ipapers2018_psydata* dataset (cs-related data items) that has `` `r nrow(ipapers2018_psydata)` `` records, and *ipapers2018*  dataset (analysed papers) with `` `r nrow(ipapers2018)` `` records.

```{r data_source, echo=FALSE}
cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata
# cs_data %>% glimpse()
# cs_data %>% skimr::skim()
# psy_data %>% glimpse()
# psy_data %>% skimr::skim()

```


```{r all_data, echo=FALSE}

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop misused columns
all_data <- all_data %>% select(-id_csin, -id_psyin, -id_year)

all_data <- all_data %>%
    inner_join(ipapers2018, by="id") %>%
    select(-filename, -title, -abstract, -journal, -author, -keywords)


# cast MD to factor
all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

n_md <- nlevels(all_data$md)
n_papers = nrow(all_data)

#all_data %>% str()
```

The final number of papers to analyse is `` `r n_papers` ``.

## Exploratory analysis

Next exploratory tables and figures attempt to figure out what's going on. The initial assumption of the paper is that the field of mental disorders (*md*) drives the analysis. So we start exploring the variables related to mental disorder, which are: 

```{r md_variables, echo=FALSE}
all_data %>%
    select(starts_with("md")) %>%
    names() 

```

### Mental disorders (MDs) 

_How many distinct MDs are there?_ 

```{r md_variability, echo=FALSE}

category_levels <- c("YES","NO")
all_data <- 
    all_data %>%
    mutate(md_dsh5 = factor(if_else(md_id <= 22, "YES", "NO"), levels=category_levels))

n_yes_dsh5 <- 
    all_data %>%
        filter(md_dsh5 == "YES") %>%
        nrow()

n_no_dsh5 <- 
    all_data %>%
        filter(md_dsh5 == "NO") %>%
        nrow()

#all_data %>% str() 


```

There are `` `r n_md` `` distinct MDs (out of 25). About `r round(n_yes_dsh5/n_papers * 100)` % (`r n_yes_dsh5`) are categorised according to DSH-5. 
About `r round(n_no_dsh5/n_papers * 100)` % (`r n_no_dsh5`) are Dual, Multiple or Suicidal Behavior Disorder/Nonsuicidal Self-Injury. 


```{r plot_md_variability, echo=FALSE}
# plot variety of mental disorders

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsh5)) +
    geom_bar() +
    coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    labs(title="Distribution of MDs", subtitle = "Colored by categorisation to DSH-5") + 
    theme_bw()

```

```{r lollipop_md_variability, echo=FALSE}

md_percent <- 
    all_data %>%
      group_by(md) %>%
      summarise(n = n()) %>%
      mutate(n_per = round(n/n_papers, 2)) %>%
      arrange(desc(n))

head(md_percent)

md_percent %>%
    ggplot(aes(y=reorder(md, n_per), x=n_per)) +
    geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
    scale_x_continuous(expand=c(0,0), labels=percent, breaks=seq(0, 0.21, by=0.03), limits=c(0, 0.21)) +
    theme_minimal() +
    labs(x=NULL, y=NULL, 
         title="Distribution of MDs",
         subtitle="Ranked by relative %",
         caption="Data from ...") 
    # theme(panel.grid.major.y=element_blank()) +
    # theme(panel.grid.minor=element_blank()) +
    # theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
    # theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
    # theme(plot.margin=unit(rep(30, 4), "pt")) +
    # theme(plot.title=element_text(face="bold")) +
    # theme(plot.subtitle=element_text(margin=margin(b=10)))

```

_Variability of MDs over time_?

```{r md_years, echo=FALSE}

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsh5)) +
    geom_bar() +
        coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    theme_bw() + 
    labs(title="Distribution of MDs by year", subtitle = "Colored by categorisation to DSH-5") + 
    facet_wrap(~ year)

```

_Top3 MDs_? 

```{r md_top3, echo=FALSE}
top3 <- levels(all_data$md)[1:3]

n_top3 <- 
    all_data %>%
        filter(md %in% top3) %>%
        nrow()

md_top3 <- 
    all_data %>%
      filter(md %in% top3) %>%
      group_by(md) %>%
      summarise(n = n()) %>%
      mutate(n_per = round(n/n_papers, 2)) %>%
      arrange(desc(n))

md_top3
```

The *top3* MD are categorised in the DSH-5, and they all cover about `r percent(n_top3/n_papers)` (`r n_top3`).


```{r lollipop_top3, echo=FALSE}

md_top3 %>%
    ggplot(aes(y=reorder(md, n_per), x=n_per)) +
    geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
    scale_x_continuous(expand=c(0,0), labels=percent, breaks=seq(0, 1, by=0.2), limits=c(0, 1)) +
    theme_minimal() +
    labs(x=NULL, y=NULL, 
        title="TOP3 mental disorders",
        subtitle="Ranked by relative %",
        caption="Data from ...")
    # theme(panel.grid.major.y=element_blank()) +
    # theme(panel.grid.minor=element_blank()) +
    # theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
    # theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
    # theme(plot.margin=unit(rep(30, 4), "pt")) +
    # theme(plot.title=element_text(face="bold")) +
    # theme(plot.subtitle=element_text(margin=margin(b=10))) +
    # theme(plot.caption=element_text(size=8, margin=margin(t=10))) 


```


### Mental disorders and subtypes

_What illnesses are specially mentioned in the paper per category of mental disorder?_

_What illnesses are included in category 23 (Dual), 24 (Multiple) and  25 (Suicidal...)?_


### Mental disorders and phsycological framework

_Which is the total coverage of CBT?_ _And the coverage of the rest of phsycological framework?_


_Which DMs are related to third wave theraphy and /or positive Psychotherapy?_


## Mental disorders and Apps

Let's start simple: _How many apps are related to the top1 MD (4-Depression)?_



### BELOW THIS LINE IS NOT VALID

```{r plot_dumbbell}


# df <- data.frame(trt=LETTERS[1:5], l=c(20, 40, 10, 30, 50), r=c(70, 50, 30, 60, 80))
# 
# ggplot(df, aes(y=trt, x=l, xend=r)) + 
#   geom_dumbbell(size=3, color="#e3e2e1", 
#                 colour_x = "#5b8124", colour_xend = "#bad744",
#                 dot_guide=TRUE, dot_guide_size=0.25) +
#   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#   theme_minimal() +
#   theme(panel.grid.major.x=element_line(size=0.05)) +
#   theme(panel.grid.major.y=element_blank())

```




```{r}
# md_data %>%
# ggplot(mapping = aes(x = md, y = n, fill = md_dsh5)) +
#     geom_bar(stat="identity") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
# 
# 
# geom_text(stat = 'count' ,aes(label = ..count..),
# nudge_y = 1.5)
# 
# 
# md_data %>%
#   group_by(md) %>%
#   summarise(n = n()) %>%
#   arrange(desc(n))  %>%
#   ggplot(mapping = aes(x = reorder(md, y = n)) +
#     geom_bar(stat="identity", fill="orange") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
```




