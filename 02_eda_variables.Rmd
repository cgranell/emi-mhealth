---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)
library(ggalt)
library(scales)

```


```{r session_info, echo=FALSE}
#devtools::session_info(include_base = TRUE)
```

This document is an EDA notebook to explore descriptive and informative figures of the datasets incldued in the *emidata* package.  

## Data 

We analyse three  datasets: *ipapers2018_csdata* dataset (psy-realted data items) has `` `r nrow(ipapers2018_csdata)` `` records, *ipapers2018_psydata* dataset (cs-related data items) that has `` `r nrow(ipapers2018_psydata)` `` records, and *ipapers2018*  dataset (analysed papers) with `` `r nrow(ipapers2018)` `` records.

```{r data_source, echo=FALSE}
cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata
# cs_data %>% glimpse()
# cs_data %>% skimr::skim()
# psy_data %>% glimpse()
# psy_data %>% skimr::skim()

```


```{r all_data, echo=FALSE}

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop "included" columns
all_data <- all_data %>% select(-id_csin, -id_psyin)

all_data <- all_data %>%
    inner_join(ipapers2018, by="id") %>%
    select(-filename, -title, -abstract, -journal, -author, -keywords)


# cast MD to factor
all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

n_md <- nlevels(all_data$md)
n_papers = nrow(all_data)

#all_data %>% str()
```

The final number of papers to analyse is `` `r n_papers` ``.

## Exploratory analysis

Next exploratory tables and figures attempt to figure out what's going on. The initial assumption of the paper is that the field of mental disorders (*md*) drives the analysis. So we start exploring the variables related to mental disorder, which are: 

```{r md_variables, echo=FALSE}
all_data %>%
    select(starts_with("md")) %>%
    names() 

```

### Mental disorders (MDs) 

_How many distinct MDs are there?_ 

```{r md_variability, echo=FALSE}

category_levels <- c("YES","NO")
all_data <- 
    all_data %>%
    mutate(md_dsh5 = factor(if_else(md_id <= 22, "YES", "NO"), levels=category_levels))

n_yes_dsh5 <- 
    all_data %>%
        filter(md_dsh5 == "YES") %>%
        nrow()

n_no_dsh5 <- 
    all_data %>%
        filter(md_dsh5 == "NO") %>%
        nrow()

#all_data %>% str() 


```

There are `` `r n_md` `` distinct MDs (out of 25). About `r percent(n_yes_dsh5/n_papers)` % (N=`r n_yes_dsh5`) are categorised according to DSH-5. 
About `r percent(n_no_dsh5/n_papers)` % (N=`r n_no_dsh5`) are 23-Dual, 24-Multiple or 25-Suicidal behavior disorder/nonsuicidal self-injury. 


```{r plot_md_variability, echo=FALSE}
# plot variety of mental disorders

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsh5)) +
    geom_bar() +
    coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    labs(title="Distribution of MDs", subtitle = "Ranked by absolute count.") + 
    theme_bw()

```

```{r lollipop_md_variability, echo=FALSE}

md_percent <- 
    all_data %>%
      group_by(md) %>%
      summarise(n = n()) %>%
      mutate(n_per = round(n/n_papers, 2)) %>%
      arrange(desc(n))

head(md_percent)

md_percent %>%
    ggplot(aes(y=reorder(md, n_per), x=n_per)) +
    geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
    scale_x_continuous(expand=c(0,0), labels=percent, breaks=seq(0, 0.21, by=0.03), limits=c(0, 0.21)) +
    theme_minimal() +
    labs(x=NULL, y=NULL, 
         title="Distribution of MDs",
         subtitle="Ranked by relative %",
         caption="Data from ...") 
    # theme(panel.grid.major.y=element_blank()) +
    # theme(panel.grid.minor=element_blank()) +
    # theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
    # theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
    # theme(plot.margin=unit(rep(30, 4), "pt")) +
    # theme(plot.title=element_text(face="bold")) +
    # theme(plot.subtitle=element_text(margin=margin(b=10)))

```

_Variability of MDs over time_?

```{r md_years, echo=FALSE}

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsh5)) +
    geom_bar() +
        coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    theme_bw() + 
    labs(title="Distribution of MDs by year", subtitle = "Absolute count. Colored by belonging to DSH-5") + 
    facet_wrap(~ year)

```

_Top3 MDs_? 

```{r md_top3, echo=FALSE}
top3 <- levels(all_data$md)[1:3]

n_top3 <- 
    all_data %>%
        filter(md %in% top3) %>%
        nrow()

md_top3 <- 
    all_data %>%
      filter(md %in% top3) %>%
      group_by(md) %>%
      summarise(n = n()) %>%
      mutate(n_per = round(n/n_papers, 2)) %>%
      arrange(desc(n))

md_top3
```

The *top3* MD are categorised in the DSH-5, and they all cover about `r percent(n_top3/n_papers)` (N=`r n_top3`).


```{r lollipop_top3, echo=FALSE}

# md_top3 %>%
#     ggplot(aes(y=reorder(md, n_per), x=n_per)) +
#     geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
#     scale_x_continuous(expand=c(0,0), labels=percent, breaks=seq(0, 1, by=0.2), limits=c(0, 1)) +
#     theme_minimal() +
#     labs(x=NULL, y=NULL, 
#         title="TOP3 mental disorders",
#         subtitle="Ranked by relative %",
#         caption="Data from ...") + 
#     theme(panel.grid.major.y=element_blank()) +
#     theme(panel.grid.minor=element_blank()) +
#     theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
#     theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
#     theme(plot.margin=unit(rep(30, 4), "pt")) +
#     theme(plot.title=element_text(face="bold")) +
#     theme(plot.subtitle=element_text(margin=margin(b=10))) +
#     theme(plot.caption=element_text(size=8, margin=margin(t=10)))


```


### Mental disorders and subtypes

_Comorbidity in cases 23-Dual and 24-multiple?_ 

Reminder: About `r percent(n_no_dsh5/n_papers)` % (N=`r n_no_dsh5`) are 23-Dual, 24-Multiple or 25-Suicidal Behavior Disorder/Nonsuicidal Self-Injury. We look at MDs which are not categorised according to the DSH-5 (id equal to 23 or 24), and check the field *md_mul*.

```{r commorbidity, echo=FALSE}

# TODO http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html

md_23or24 <- 
    all_data %>% 
    filter(md_id==23 | md_id==24) %>% 
    separate_rows(sep = ";", md_mul)

md_23or24$md_mul <- str_trim(md_23or24$md_mul)

md_23or24 <- 
    md_23or24 %>% 
      group_by(md_mul, md_id) %>%  # first create counts for each group
      summarise(number_cases = n()) %>%
      group_by(md_mul) %>%
      mutate(total_cases = sum(number_cases),
             proportion = number_cases/total_cases) # Create total counts 

head(md_23or24)
```

A way to visualizing two discrete variables is by using a stacked bar plot 

```{r plot_commorbidity, echo=FALSE}

md_23or24 %>%
  ggplot(aes(x=md_mul, y=number_cases, fill=factor(md_id))) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  labs(title="Commorbidity. Absolute count") +
  theme_minimal()


md_23or24 %>%
    ggplot(aes(x=md_mul, y=proportion, fill=factor(md_id))) + 
    geom_bar(stat="identity", position="stack") +
    geom_text(aes(x=md_mul, y=0.05, label=total_cases), size=3, colour="white") +
    scale_y_continuous(labels = scales::percent_format()) +
    coord_flip() +
    labs(title="Commorbidity. Proportional stacked bar") +
    theme_minimal()


```

An alternative way is by using a bubble plot.

```{r bubbleplot_commorbidity, echo=FALSE }
# Source: http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html#bubbleplot

md_23or24 %>%
    ggplot(aes(x=md_mul, y=factor(md_id))) +
    geom_count(aes(size=..prop..), colour="lightgrey") +
    geom_point(aes(size=proportion), colour="cornflowerblue") + 
    scale_size(range = c(0,10), breaks=seq(0,1,by=0.2)) +
    #scale_size(range = c(0.4,1.0), breaks=seq(0.4,1.0,by=0.1)) +
    #geom_point(aes(size=proportion)) + 
    coord_flip() +
    labs(title="Commorbidity. Proportional bubble plot") +
    theme_minimal()


```


_What subtypes of illnesses are mentioned (in the papers) per each category of mental disorder in DSH-5?_ 

We look at MDs which are categorised according to the DSH-5 (id <> 23 or 24), and check the field *md_sub*.

```{r subtypes}

#' Source: http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html

md_subtypes <- 
    all_data %>% 
    filter(md_id!=23 & md_id!=24) %>%
    drop_na(md_sub)

md_subtypes$md_sub <- str_to_lower(md_subtypes$md_sub)

md_subtypes %>%
    group_by(md_id, md_desc, md_sub)  %>%  # first create counts for each group
    summarise(number_cases = n())


#separate_rows(sep = ";", md_mul)

#' Source: https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html
#' Source: http://corybrunson.github.io/ggalluvial/index.html

library(ggalluvial)

# TODO: Error: Too many colors
md_subtypes %>%
    group_by(md_id, md_sub)  %>%  # first create counts for each group
    summarise(number_cases = n()) %>%
    ggplot(aes(y = number_cases, axis1=md_id, axis2=md_sub)) +
    geom_alluvium(aes(fill=md_sub), width = 1/12) +
    geom_stratum(width = 1/12, fill = "black", color = "grey") +
    geom_label(stat = "stratum", label.strata = TRUE) +
    #scale_x_discrete (breaks = 1:2, labels = c("MD", "Subtype")) +
    scale_x_discrete(limits = c("MDs", "Subtypes"), expand = c(.05, .05)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +  
    theme(legend.position = "bottom") +
    labs(title="Mental disorders and subtypes. Alluvial plot") +
    theme_minimal()



md_subtypes %>%
    group_by(md_id, md_sub)  %>%  # first create counts for each group
    summarise(number_cases = n()) %>%
    ggplot(aes(y = number_cases, axis1=md_id, axis2=md_sub)) +
    stat_stratum(geom = "errorbar") +
  geom_line(stat = "alluvium") +
  stat_alluvium(geom = "pointrange") +
  geom_text(stat = "stratum", label.strata = TRUE) +
  scale_x_discrete(limits = c("MDs", "Subtypes"), expand = c(.05, .05))


#' Source: http://jokergoo.github.io/circlize/example/bi_directional.html
    

```


### Mental disorders and phsycological framework

_Which is the total coverage of CBT?_ _And the coverage of the rest of phsycological framework?_


_Which DMs are related to third wave theraphy and /or positive Psychotherapy?_


## Mental disorders and Apps

Let's start simple: _How many apps are related to the top1 MD (4-Depression)?_



### BELOW THIS LINE IS NOT VALID

```{r plot_dumbbell}


# df <- data.frame(trt=LETTERS[1:5], l=c(20, 40, 10, 30, 50), r=c(70, 50, 30, 60, 80))
# 
# ggplot(df, aes(y=trt, x=l, xend=r)) + 
#   geom_dumbbell(size=3, color="#e3e2e1", 
#                 colour_x = "#5b8124", colour_xend = "#bad744",
#                 dot_guide=TRUE, dot_guide_size=0.25) +
#   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#   theme_minimal() +
#   theme(panel.grid.major.x=element_line(size=0.05)) +
#   theme(panel.grid.major.y=element_blank())

```




```{r}
# md_data %>%
# ggplot(mapping = aes(x = md, y = n, fill = md_dsh5)) +
#     geom_bar(stat="identity") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
# 
# 
# geom_text(stat = 'count' ,aes(label = ..count..),
# nudge_y = 1.5)
# 
# 
# md_data %>%
#   group_by(md) %>%
#   summarise(n = n()) %>%
#   arrange(desc(n))  %>%
#   ggplot(mapping = aes(x = reorder(md, y = n)) +
#     geom_bar(stat="identity", fill="orange") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
```




