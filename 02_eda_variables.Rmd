---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

## Metadata

Required libraries and runtime environment description.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(emidata)
library(tidyverse)
library(tidytext)
library(kableExtra)
library(stringr)
library(skimr)
library(ggalt)
library(scales)
library(easyalluvial)
library(RColorBrewer)
library(gridExtra)


```


```{r session_info, echo=FALSE}
#devtools::session_info(include_base = TRUE)
```

This document is an EDA notebook to explore descriptive and informative figures of the datasets incldued in the *emidata* package.  

## Data 

We analyse three datasets: 

* *ipapers2018_psydata* (extracted data items related to psychology) has `` `r nrow(ipapers2018_psydata)` `` records and `` `r ncol(ipapers2018_psydata)` `` columns.
* *ipapers2018_csdata* (extracted data items related to tech/cs) has `` `r nrow(ipapers2018_csdata)` `` records and `` `r ncol(ipapers2018_csdata)` `` columns. 
* *ipapers2018* (list of analysed papers) has `` `r nrow(ipapers2018)` `` records and `` `r ncol(ipapers2018)` `` columns.

```{r data_source, echo=FALSE}
cs_data <- ipapers2018_csdata
psy_data <- ipapers2018_psydata
# cs_data %>% glimpse()
# cs_data %>% skimr::skim()
# psy_data %>% glimpse()
# psy_data %>% skimr::skim()

```


```{r all_data, echo=FALSE}

all_data <- psy_data %>%
    inner_join(cs_data, by="id")

# Drop "included" columns
all_data <- all_data %>% select(-id_csin, -id_psyin)

all_data <- all_data %>%
    inner_join(ipapers2018, by="id") %>%
    select(-filename, -title, -abstract, -journal, -author, -keywords)


# cast MD to factor
all_data$md <- factor(all_data$md, levels=names(sort(table(all_data$md), decreasing=T)))

n_md <- nlevels(all_data$md)
n_papers = nrow(all_data)

#all_data %>% str()
```

The final number of papers to analyse is `` `r n_papers` ``.

## Exploratory analysis

Next exploratory tables and figures attempt to figure out what's going on. The initial assumption of the paper is that the field of mental disorder (*md*) drives the analysis. So we start exploring the related columns (variables), which are: 

```{r md_variables, echo=FALSE}
all_data %>%
    select(starts_with("md")) %>%
    names() 

```

### Mental disorders (MDs) 

_How many distinct MDs are there?_ 

```{r md_variability, echo=FALSE}

category_levels <- c("YES","NO")
all_data <- 
    all_data %>%
    mutate(md_dsm5 = factor(if_else(md_id <= 22, "YES", "NO"), levels=category_levels))

n_yes_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "YES") %>%
        nrow()

n_no_dsm5 <- 
    all_data %>%
        filter(md_dsm5 == "NO") %>%
        nrow()

#all_data %>% str() 


```

There are `` `r n_md` `` distinct MDs (out of 25). About `r percent(n_yes_dsm5/n_papers)` (N=`r n_yes_dsm5`) are categorised according to Section II of  [DSM-5 manual](https://dsm.psychiatryonline.org/doi/book/10.1176/appi.books.9780890425596). About `r percent(n_no_dsm5/n_papers)` (N=`r n_no_dsm5`) are 23-Dual, 24-Multiple or 25-Suicidal behavior disorder/nonsuicidal self-injury. 


```{r plot_md_variability, echo=FALSE}
# plot variety of mental disorders

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsm5)) +
    geom_bar() +
    coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    labs(title="Distribution of MDs", subtitle = "Ranked by absolute count.") + 
    theme_bw()

```

```{r lollipop_md_variability, echo=FALSE}

md_percent <- 
    all_data %>%
      group_by(md) %>%
      summarise(n = n()) %>%
      mutate(proportion = n/n_papers) %>%
      arrange(desc(n))

# head(md_percent)

md_percent %>%
    ggplot(aes(y=reorder(md, proportion), x=proportion)) +
    geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
    scale_x_continuous(expand=c(0,0), labels=scales::percent_format(), breaks=seq(0, 0.20, by=0.02), limits=c(0, 0.20)) +
    theme_minimal() +
    labs(x=NULL, y=NULL, 
         title="Distribution of MDs",
         subtitle="Ranked by relative %",
         caption="Data from ...") 
    # theme(panel.grid.major.y=element_blank()) +
    # theme(panel.grid.minor=element_blank()) +
    # theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
    # theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
    # theme(plot.margin=unit(rep(30, 4), "pt")) +
    # theme(plot.title=element_text(face="bold")) +
    # theme(plot.subtitle=element_text(margin=margin(b=10)))

```

_Top3 MDs_? 

```{r md_top3, echo=FALSE}
top3 <- levels(all_data$md)[1:3]

n_top3 <- 
    all_data %>%
        filter(md %in% top3) %>%
        nrow()

md_top3 <- 
    all_data %>%
      filter(md %in% top3) %>%
      group_by(md) %>%
      summarise(number_cases = n()) %>%
      mutate(proportion = round(number_cases/n_papers, 2)) %>%
      arrange(desc(number_cases))

md_top3
```

The *top3* MDs are categorised in the DSM-5, and they all cover about `r percent(n_top3/n_papers)` (N=`r n_top3`).

```{r lollipop_top3, echo=FALSE}

# md_top3 %>%
#     ggplot(aes(y=reorder(md, n_per), x=n_per)) +
#     geom_lollipop(point.colour = 'steelblue', point.size = 2,horizontal = TRUE) +
#     scale_x_continuous(expand=c(0,0), labels=percent, breaks=seq(0, 1, by=0.2), limits=c(0, 1)) +
#     theme_minimal() +
#     labs(x=NULL, y=NULL, 
#         title="TOP3 mental disorders",
#         subtitle="Ranked by relative %",
#         caption="Data from ...") + 
#     theme(panel.grid.major.y=element_blank()) +
#     theme(panel.grid.minor=element_blank()) +
#     theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
#     theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
#     theme(plot.margin=unit(rep(30, 4), "pt")) +
#     theme(plot.title=element_text(face="bold")) +
#     theme(plot.subtitle=element_text(margin=margin(b=10))) +
#     theme(plot.caption=element_text(size=8, margin=margin(t=10)))


```

_Variability of MDs over time_?

```{r md_years, echo=FALSE}

all_data %>%
  ggplot(mapping = aes(x = md, fill=md_dsm5)) +
    geom_bar() +
        coord_flip() +
    geom_text(stat = 'count', aes(label = ..count..), nudge_y = 0.5, size = 2) +
    theme_bw() + 
    labs(title="Distribution of MDs by year", subtitle = "Absolute count. Colored by belonging to DSM-5") + 
    facet_wrap(~ year)

```

_Note: The period 2013-2017 covers full years. 2018 only covers the first two months (Bibliographic searches were conducted at the beginning of March 2018)._ 

Remarks:

* There is no clear temporal trend. Only that the last years attract more papers.
* Top3 mental disorders (`r top3`) remain significant over years.



```{r md_years_area, echo=FALSE}

all_data %>% 
    group_by(year) %>%  # first create counts for each group
    summarise(number_cases = n()) %>% 
    ggplot(aes(x=year, y=number_cases )) +
    geom_area(colour="cornflowerblue", fill = "cornflowerblue", 
              alpha=0.5, # Make the fill see through 50%)
              size=0.5) + # Make the size of the borders smaller
    geom_text(aes(label = number_cases), color= "blue", nudge_y = -1, size = 3) +
    geom_vline(aes(xintercept = 2017), linetype = 'dashed', size = 0.5)


```


Remarks:

* There is a sharp peak in 2016-2017 compared to 2013-2015. 
* The 2015-2016 period accounts for (`r percent(60/n_papers)`), while 2013-2015 accounts for (`r percent(32/n_papers)`).
* Only two months of 2018 (`r percent(12/n_papers)`) almost reach the amount of documents in 2012 and 2013 together (`r percent(15/n_papers)`).


```{r md_years_alluvial, echo=FALSE}

#' TODO ONGOING
md_by_year <- 
    all_data %>% 
    group_by(md_id, md_desc, year) %>%  # first create counts for each group
    summarise(number_cases = n()) %>% 
    group_by(year) %>%
    mutate(total_cases = sum(number_cases),
           proportion = number_cases/total_cases) %>% # Create total counts 
    ungroup() %>%
    as_tibble()

    
# md_by_year2 <- 
#     all_data %>% 
#     group_by(md_id, md_desc, year)  %>%    
#     expand(year)
# 
#     summarise(number_cases = n()) %>% 
#     expand(md_id, year, number_cases)
#     summarise(number_cases = n()) %>% 
#     group_by(year) %>%
#     mutate(total_cases = sum(number_cases),
#            proportion = number_cases/total_cases) %>% # Create total counts 
#       .[complete.cases(.), ]
#     ungroup() %>%
#     as_tibble()
    
    
# md_by_year %>%  str()


# source: https://www.r-bloggers.com/how-to-expand-color-palette-with-ggplot-and-rcolorbrewer/
n_colors <- length(unique(md_by_year$md_id))
get_palette <- colorRampPalette(brewer.pal(9, "Set1"))


# https://www.rdocumentation.org/packages/easyalluvial/versions/0.1.8/topics/alluvial_long
alluvial_long(md_by_year, 
              key = year, 
              value = proportion, 
              id = md_id, 
              bins = n_colors,
              NA_label = "NA",
              bin_labels = as.character(unique(md_by_year$md_id)),
              fill_by = 'all_flows',
              col_vector_flow = get_palette(n_colors),
              col_vector_value = get_palette(n_colors)
)
      

```



### Mental disorders and subtypes

_Comorbidity in cases 23-Dual and 24-multiple?_ 

Reminder: About `r percent(n_no_dsm5/n_papers)` (N=`r n_no_dsm5`) are 23-Dual, 24-Multiple or 25-Suicidal Behavior Disorder/Nonsuicidal Self-Injury. We look at MDs which are not categorised according to the DSm-5 (23 or 24), and check the field *md_mul* that lists the mutliple MDs.

```{r commorbidity, echo=FALSE}

# TODO http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html

md_23or24 <- 
    all_data %>% 
    filter(md_id==23 | md_id==24) %>% 
    separate_rows(sep = ";", md_mul)

md_23or24$md_mul <- str_trim(md_23or24$md_mul)

md_23or24 <- 
    md_23or24 %>% 
      group_by(md_mul, md_id) %>%  # first create counts for each group
      summarise(number_cases = n()) %>%
      group_by(md_mul) %>%
      mutate(total_cases = sum(number_cases),
             proportion = number_cases/total_cases) # Create total counts 

#head(md_23or24)
```

A way to visualizing the two discrete variables is by using a stacked bar plot 

```{r plot_commorbidity, echo=FALSE}


#plot_left <- 
md_23or24 %>%
  ggplot(aes(x=md_mul, y=number_cases, fill=factor(md_id))) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  labs(title="Commorbidity. Absolute count") +
  theme_minimal()

#plot_right <- 
md_23or24 %>%
    ggplot(aes(x=md_mul, y=proportion, fill=factor(md_id))) + 
    geom_bar(stat="identity", position="stack") +
    geom_text(aes(x=md_mul, y=0.05, label=total_cases), size=3, colour="white") +
    scale_y_continuous(labels = scales::percent_format()) +
    coord_flip() +
    labs(title="Commorbidity. Proportional stacked bar") +
    theme_minimal()


#gridExtra::grid.arrange(plot_left, plot_right, nrow = 1)
```

An alternative way is by using a bubble plot.

```{r bubbleplot_commorbidity, echo=FALSE }
# Source: http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html#bubbleplot

md_23or24 %>%
    ggplot(aes(x=md_mul, y=factor(md_id))) +
    geom_count(aes(size=..prop..), colour="lightgrey") +
    geom_point(aes(size=proportion), colour="cornflowerblue") + 
    scale_size(range = c(0,10), breaks=seq(0,1,by=0.2)) +
    #scale_size(range = c(0.4,1.0), breaks=seq(0.4,1.0,by=0.1)) +
    #geom_point(aes(size=proportion)) + 
    coord_flip() +
    labs(title="Commorbidity. Proportional bubble plot") +
    theme_minimal()


```


_What subtypes of illnesses are mentioned (in the papers) per each category of mental disorder in DSM-5?_ 

We look at MDs which are categorised according to the DSM-5 (id <> 23 or 24), and check the field *md_sub*.

```{r subtypes, echo=FALSE}

#' Source: http://stulp.gmw.rug.nl/ggplotworkshop/twodiscretevariables.html
#' TODO ONGOIND
md_subtypes <- 
    all_data %>% 
    filter(md_id!=23 & md_id!=24) %>%
    drop_na(md_sub)

md_subtypes$md_sub <- str_to_lower(md_subtypes$md_sub)

# md_subtypes %>%
#     group_by(md_id, md_desc, md_sub)  %>%  # first create counts for each group
#     summarise(number_cases = n())


#separate_rows(sep = ";", md_mul)

#' ggalluvial, source: https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html
#' ggalluvial, source: http://corybrunson.github.io/ggalluvial/index.html
#' easyalluvial, source: https://github.com/erblast/easyalluvial/blob/master/README.md
library(ggalluvial)

# TODO: Error: Too many colors
# md_subtypes %>%
#     group_by(md_id, md_sub)  %>%  # first create counts for each group
#     summarise(number_cases = n()) %>%
#     ggplot(aes(y = number_cases, axis1=md_id, axis2=md_sub)) +
#     geom_alluvium(aes(fill=md_sub), width = 1/12) +
#     geom_stratum(width = 1/12, fill = "black", color = "grey") +
#     geom_label(stat = "stratum", label.strata = TRUE) +
#     #scale_x_discrete (breaks = 1:2, labels = c("MD", "Subtype")) +
#     scale_x_discrete(limits = c("MDs", "Subtypes"), expand = c(.05, .05)) +
#     scale_fill_brewer(type = "qual", palette = "Set1") +  
#     theme(legend.position = "bottom") +
#     labs(title="Mental disorders and subtypes. Alluvial plot") +
#     theme_minimal()


# md_subtypes %>%
#     group_by(md_id, md_sub)  %>%  # first create counts for each group
#     summarise(number_cases = n()) %>%
#     ggplot(aes(y = number_cases, axis1=md_id, axis2=md_sub)) +
#     stat_stratum(geom = "errorbar") +
#   geom_line(stat = "alluvium") +
#   stat_alluvium(geom = "pointrange") +
#   geom_text(stat = "stratum", label.strata = TRUE) +
#   scale_x_discrete(limits = c("MDs", "Subtypes"), expand = c(.05, .05))


#' circlize, source: http://jokergoo.github.io/circlize/example/bi_directional.html
    

```


### Mental disorders and phsycological framework

_Which is the total coverage of CBT?_ _And the coverage of the rest of phsycological framework?_


_Which DMs are related to third wave theraphy and /or positive Psychotherapy?_


## Mental disorders and Apps

Let's start simple: _How many apps are related to the top1 MD (4-Depression)?_



### BELOW THIS LINE IS NOT VALID

```{r plot_dumbbell, echo=FALSE}


# df <- data.frame(trt=LETTERS[1:5], l=c(20, 40, 10, 30, 50), r=c(70, 50, 30, 60, 80))
# 
# ggplot(df, aes(y=trt, x=l, xend=r)) + 
#   geom_dumbbell(size=3, color="#e3e2e1", 
#                 colour_x = "#5b8124", colour_xend = "#bad744",
#                 dot_guide=TRUE, dot_guide_size=0.25) +
#   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#   theme_minimal() +
#   theme(panel.grid.major.x=element_line(size=0.05)) +
#   theme(panel.grid.major.y=element_blank())

```




```{r}
# md_data %>%
# ggplot(mapping = aes(x = md, y = n, fill = md_dsm5)) +
#     geom_bar(stat="identity") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
# 
# 
# geom_text(stat = 'count' ,aes(label = ..count..),
# nudge_y = 1.5)
# 
# 
# md_data %>%
#   group_by(md) %>%
#   summarise(n = n()) %>%
#   arrange(desc(n))  %>%
#   ggplot(mapping = aes(x = reorder(md, y = n)) +
#     geom_bar(stat="identity", fill="orange") +
#     coord_flip() +
#     geom_text(aes(label = n), nudge_y = 0.5, size = 2) +
#     theme_bw()
```




